# motor-light

基于 ESP32 的摩托车弯道辅助灯控制系统。通过 MPU6050 检测车身倾角，在发动机运行且大灯开启的前提下，根据左右倾斜自动控制左右辅助灯亮灭。

## 功能介绍

- **发动机/大灯检测**：ADC 采集发动机电压（GPIO34）和大灯电压（GPIO35），仅在这两者满足条件时系统才允许工作
- **倾角检测**：MPU6050 通过 I2C 获取姿态，经低通滤波和互补滤波得到 Roll 角度
- **左右灯控制**：倾角 > 10° 持续 400ms 开启左侧灯，倾角 < -10° 持续 400ms 开启右侧灯；回正后持续 400ms 自动关闭
- **看门狗**：3 秒超时防止死机

## 硬件接线

| 模块     | 引脚 | 说明       |
|----------|------|------------|
| ADC 发动机 | GPIO34 | 发动机电压分压采样 |
| ADC 大灯   | GPIO35 | 大灯电压分压采样   |
| MPU6050 SDA | GPIO21 | I2C 数据线      |
| MPU6050 SCL | GPIO22 | I2C 时钟线      |
| 左侧 MOS  | GPIO18 | 左侧灯控制输出   |
| 右侧 MOS  | GPIO19 | 右侧灯控制输出   |

### 电压采样电路（发动机 / 大灯）

- **分压电阻**：100kΩ 与 20kΩ 串联，分压比约 1:6（20k / 120k）
- **输入电压**：≤ 24V
- **钳位保护**：ADC 引脚经 3.6V 齐纳二极管串联到 GND，防止过压损坏 ESP32

> **重要**：本方案要求 ESP32 与摩托车电气系统**共地**，否则无法正确采样电压。

## 项目结构

```
motor-light/
├── main/
│   └── main.c              # 主逻辑
├── components/
│   ├── adc_manager/        # ADC 采集、发动机/大灯状态判断（滞回）
│   ├── mpu6050_manager/    # MPU6050 驱动、角度解算、滤波与校准
│   └── mos_control/        # MOS 管 GPIO 输出控制
├── CMakeLists.txt
└── README.md
```

## 依赖

- [ESP-IDF](https://docs.espressif.com/projects/esp-idf/)（推荐 v5.x）

## 构建与烧录

```bash
# 设置 ESP-IDF 环境
. $IDF_PATH/export.sh

# 配置、编译、烧录
idf.py set-target esp32
idf.py build
idf.py -p /dev/ttyUSB0 flash monitor
```

## 配置说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `ANGLE_THRESHOLD` | 10.0° | 触发左右灯的最小倾角 |
| `TRIGGER_TIME_MS` | 400 ms | 保持倾角多少毫秒后才切换灯 |
| 发动机开启阈值 | 2.6V | 判定发动机运行 |
| 发动机关闭阈值 | 2.4V | 滞回下限 |
| 大灯开启阈值 | 2.5V | 判定大灯点亮 |
| 大灯关闭阈值 | 2.2V | 滞回下限 |

## 许可证

MIT
